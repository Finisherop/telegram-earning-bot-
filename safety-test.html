<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Safety Test Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .test-result {
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }
        .success { background-color: #f0fdf4; border-color: #bbf7d0; }
        .error { background-color: #fef2f2; border-color: #fca5a5; }
        .info { background-color: #eff6ff; border-color: #93c5fd; }
        .warning { background-color: #fffbeb; border-color: #fcd34d; }
    </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8">🛡️ Enhanced Safety Test Suite</h1>
        
        <!-- Test Environment Info -->
        <div class="bg-white rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Test Environment</h2>
            <div id="testEnvironment" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div><strong>URL:</strong> <span id="currentUrl" class="font-mono"></span></div>
                <div><strong>User Agent:</strong> <span id="userAgent" class="font-mono text-xs"></span></div>
                <div><strong>Telegram WebApp:</strong> <span id="telegramStatus" class="font-semibold"></span></div>
                <div><strong>Secure Context:</strong> <span id="secureContext" class="font-semibold"></span></div>
                <div><strong>Clipboard API:</strong> <span id="clipboardSupport" class="font-semibold"></span></div>
                <div><strong>Firebase Status:</strong> <span id="firebaseStatus" class="font-semibold">Checking...</span></div>
            </div>
        </div>

        <!-- Safety Test Controls -->
        <div class="bg-white rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Safety Tests</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <button onclick="testSafeFirebase()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    🔥 Firebase Safety
                </button>
                <button onclick="testSafeTelegram()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    📱 Telegram Safety
                </button>
                <button onclick="testErrorHandling()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                    ⚠️ Error Handling
                </button>
                <button onclick="testConnectionFailures()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    🔌 Connection Failures
                </button>
                <button onclick="testRetryMechanisms()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    🔄 Retry Logic
                </button>
                <button onclick="testSafeCleanup()" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600">
                    🧹 Safe Cleanup
                </button>
                <button onclick="testUndefinedHandling()" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                    ❓ Undefined Values
                </button>
                <button onclick="runAllSafetyTests()" class="bg-gray-800 text-white px-4 py-2 rounded hover:bg-gray-900">
                    🛡️ Run All Tests
                </button>
            </div>
        </div>

        <!-- Stress Test Controls -->
        <div class="bg-white rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Stress Tests</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <button onclick="stressTestNotifications()" class="bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600">
                    🔔 Notification Spam
                </button>
                <button onclick="stressTestListeners()" class="bg-teal-500 text-white px-4 py-2 rounded hover:bg-teal-600">
                    👂 Listener Overload
                </button>
                <button onclick="simulateNetworkIssues()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                    🌐 Network Issues
                </button>
            </div>
        </div>

        <!-- Test Results -->
        <div class="bg-white rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Test Results</h2>
            <div class="mb-4">
                <button onclick="clearResults()" class="bg-gray-500 text-white px-3 py-1 rounded text-sm">
                    Clear Results
                </button>
            </div>
            <div id="testResults" class="space-y-2">
                <div class="test-result info">
                    <strong>Safety Test Suite Ready</strong> - Enhanced error handling and fallback mechanisms loaded
                </div>
            </div>
        </div>
    </div>

    <!-- Load Firebase and App Scripts -->
    <script type="module">
        // Initialize test environment
        document.getElementById('currentUrl').textContent = window.location.href;
        document.getElementById('userAgent').textContent = navigator.userAgent;
        document.getElementById('telegramStatus').textContent = 
            window.Telegram && window.Telegram.WebApp ? 'Available ✅' : 'Not Available (Testing Mode) ⚠️';
        document.getElementById('secureContext').textContent = 
            window.isSecureContext ? 'Secure ✅' : 'Insecure ⚠️';
        document.getElementById('clipboardSupport').textContent = 
            navigator.clipboard ? 'Supported ✅' : 'Not Supported ❌';

        // Test results container
        const testResults = document.getElementById('testResults');

        function addTestResult(title, status, details = '') {
            const result = document.createElement('div');
            result.className = `test-result ${status}`;
            result.innerHTML = `
                <strong>${title}</strong> - ${
                    status === 'success' ? 'PASS ✅' : 
                    status === 'error' ? 'FAIL ❌' : 
                    status === 'warning' ? 'WARN ⚠️' :
                    'INFO ℹ️'
                }
                ${details ? `<div class="text-sm mt-2 font-mono">${details}</div>` : ''}
                <div class="text-xs text-gray-500 mt-1">${new Date().toLocaleTimeString()}</div>
            `;
            testResults.appendChild(result);
            result.scrollIntoView({ behavior: 'smooth' });
        }

        window.clearResults = function() {
            testResults.innerHTML = '';
        };

        // ✅ Test Safe Firebase Operations
        window.testSafeFirebase = async function() {
            addTestResult('Firebase Safety Test', 'info', 'Testing safe Firebase operations...');

            try {
                // Wait for Firebase with timeout
                let firebaseLoaded = false;
                const timeout = setTimeout(() => {
                    if (!firebaseLoaded) {
                        addTestResult('Firebase Timeout', 'warning', 'Firebase took too long to load');
                    }
                }, 5000);

                while (!window.Firebase && Date.now() - startTime < 10000) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                firebaseLoaded = true;
                clearTimeout(timeout);

                if (!window.Firebase) {
                    addTestResult('Firebase Load', 'error', 'Firebase failed to load within 10 seconds');
                    return;
                }

                document.getElementById('firebaseStatus').textContent = 'Loaded ✅';
                addTestResult('Firebase Load', 'success', 'Firebase loaded successfully');

                // Test safe user creation with undefined values
                const testUser = await window.Firebase.createUser('test_safe_user', {
                    username: undefined,
                    firstName: null,
                    coins: undefined,
                    invalidField: 'should be filtered'
                });

                if (testUser) {
                    addTestResult('Safe User Creation', 'success', 
                        `Created user with safe defaults: coins=${testUser.coins}, username="${testUser.username}"`);
                } else {
                    addTestResult('Safe User Creation', 'error', 'Failed to create user with safe defaults');
                }

                // Test retry mechanism
                const retrySuccess = await window.Firebase.retryOperation(
                    () => { throw new Error('Simulated failure'); }, 
                    2, 
                    100
                );
                
                addTestResult('Retry Mechanism', retrySuccess ? 'error' : 'success', 
                    'Retry mechanism correctly failed after exhausting attempts');

                // Test safe disconnect
                window.Firebase.safeDisconnect([null, undefined, 'invalid']);
                addTestResult('Safe Disconnect', 'success', 'Safe disconnect handled null/invalid listeners');

            } catch (error) {
                addTestResult('Firebase Safety Error', 'error', error.message);
            }
        };

        // ✅ Test Safe Telegram Operations
        window.testSafeTelegram = async function() {
            addTestResult('Telegram Safety Test', 'info', 'Testing Telegram WebApp safety features...');

            try {
                // Load Telegram utilities
                while (!window.TelegramApp) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                const telegram = window.TelegramApp;

                // Test safe haptic feedback
                telegram.hapticFeedback('invalid_type');
                addTestResult('Safe Haptic Feedback', 'success', 'Invalid haptic type handled gracefully');

                // Test safe showAlert with various parameters
                telegram.showAlert(''); // Empty message
                telegram.showAlert(null); // Null message
                telegram.showAlert('Test message', null, 'Test Title'); // Null callback
                addTestResult('Safe Alert Methods', 'success', 'Alert methods handled edge cases');

                // Test safe clipboard operations
                telegram.copyToClipboard(''); // Empty text
                telegram.copyToClipboard(null); // Null text
                addTestResult('Safe Clipboard', 'success', 'Clipboard operations handled empty/null values');

                // Test safe link operations
                telegram.openLink(''); // Empty URL
                telegram.openTelegramLink(null); // Null URL
                addTestResult('Safe Link Operations', 'success', 'Link operations handled invalid URLs');

                // Test main button operations
                telegram.showMainButton('', null); // Empty text, null callback
                telegram.hideMainButton(); // Should not throw
                addTestResult('Safe Main Button', 'success', 'Main button operations handled safely');

            } catch (error) {
                addTestResult('Telegram Safety Error', 'error', error.message);
            }
        };

        // ✅ Test Error Handling
        window.testErrorHandling = async function() {
            addTestResult('Error Handling Test', 'info', 'Testing comprehensive error handling...');

            try {
                // Simulate various error conditions
                const errorTests = [
                    () => { throw new Error('Network timeout'); },
                    () => { throw new TypeError('Invalid type'); },
                    () => { throw new ReferenceError('Undefined variable'); },
                    () => { return Promise.reject('Async error'); }
                ];

                let passedTests = 0;
                for (const [index, errorTest] of errorTests.entries()) {
                    try {
                        await errorTest();
                        addTestResult(`Error Test ${index + 1}`, 'warning', 'Expected error was not thrown');
                    } catch (error) {
                        passedTests++;
                        addTestResult(`Error Test ${index + 1}`, 'success', `Caught ${error.constructor.name}: ${error.message}`);
                    }
                }

                addTestResult('Error Handling Summary', 'success', `${passedTests}/${errorTests.length} error types handled correctly`);

            } catch (error) {
                addTestResult('Error Handling Test Failed', 'error', error.message);
            }
        };

        // ✅ Test Connection Failures
        window.testConnectionFailures = async function() {
            addTestResult('Connection Failure Test', 'info', 'Simulating connection issues...');

            try {
                // Temporarily break Firebase connection
                const originalFirebase = window.Firebase;
                
                // Simulate Firebase unavailable
                window.Firebase = null;
                
                // Test fallback behavior
                if (window.DatabaseManager) {
                    const dbManager = new window.DatabaseManager();
                    await dbManager.init(); // Should not crash
                    addTestResult('Database Fallback', 'success', 'Database manager handled missing Firebase gracefully');
                }

                // Restore Firebase
                window.Firebase = originalFirebase;
                
                // Test connection health check
                if (window.Firebase && typeof window.Firebase.readData === 'function') {
                    const healthCheck = await window.Firebase.readData('nonexistent/path');
                    addTestResult('Connection Health Check', 'success', 'Health check completed without errors');
                }

            } catch (error) {
                addTestResult('Connection Failure Test Error', 'error', error.message);
            }
        };

        // ✅ Test Retry Mechanisms
        window.testRetryMechanisms = async function() {
            addTestResult('Retry Mechanism Test', 'info', 'Testing retry logic and exponential backoff...');

            let attemptCount = 0;
            const maxAttempts = 3;

            const flakyOperation = () => {
                attemptCount++;
                if (attemptCount < maxAttempts) {
                    throw new Error(`Attempt ${attemptCount} failed`);
                }
                return 'Success!';
            };

            try {
                if (window.Firebase && typeof window.Firebase.retryOperation === 'function') {
                    const result = await window.Firebase.retryOperation(flakyOperation, maxAttempts, 50);
                    if (result) {
                        addTestResult('Retry Success', 'success', `Operation succeeded after ${attemptCount} attempts`);
                    } else {
                        addTestResult('Retry Failure', 'error', 'Retry operation failed to recover');
                    }
                } else {
                    addTestResult('Retry Not Available', 'warning', 'Retry mechanism not found');
                }

            } catch (error) {
                addTestResult('Retry Test Error', 'error', error.message);
            }
        };

        // ✅ Test Safe Cleanup
        window.testSafeCleanup = async function() {
            addTestResult('Safe Cleanup Test', 'info', 'Testing cleanup mechanisms...');

            try {
                // Create mock listeners and timers
                const mockListeners = [null, undefined, { disconnect: () => {} }];
                const timers = [];
                
                for (let i = 0; i < 5; i++) {
                    timers.push(setTimeout(() => {}, 1000));
                }

                // Test Firebase safe disconnect
                if (window.Firebase && typeof window.Firebase.safeDisconnect === 'function') {
                    window.Firebase.safeDisconnect(mockListeners);
                    addTestResult('Firebase Cleanup', 'success', 'Firebase cleanup handled mixed listener types');
                }

                // Clean up timers
                timers.forEach(timer => clearTimeout(timer));
                addTestResult('Timer Cleanup', 'success', 'All timers cleared successfully');

                // Test app cleanup if available
                if (window.app && typeof window.app.cleanup === 'function') {
                    window.app.cleanup();
                    addTestResult('App Cleanup', 'success', 'App cleanup executed without errors');
                }

            } catch (error) {
                addTestResult('Cleanup Test Error', 'error', error.message);
            }
        };

        // ✅ Test Undefined Value Handling
        window.testUndefinedHandling = async function() {
            addTestResult('Undefined Value Test', 'info', 'Testing null coalescing and safe defaults...');

            try {
                const testCases = [
                    { value: undefined, expected: 'default' },
                    { value: null, expected: 'default' },
                    { value: '', expected: '' },
                    { value: 0, expected: 0 },
                    { value: false, expected: false }
                ];

                let passedCases = 0;
                testCases.forEach((testCase, index) => {
                    const result = testCase.value ?? 'default';
                    const passed = result === testCase.expected;
                    if (passed) passedCases++;
                    
                    addTestResult(`Nullish Coalescing ${index + 1}`, passed ? 'success' : 'error',
                        `${testCase.value} ?? 'default' = ${result} (expected: ${testCase.expected})`);
                });

                addTestResult('Undefined Handling Summary', 'success', 
                    `${passedCases}/${testCases.length} null coalescing tests passed`);

            } catch (error) {
                addTestResult('Undefined Test Error', 'error', error.message);
            }
        };

        // ✅ Stress Tests
        window.stressTestNotifications = function() {
            addTestResult('Notification Stress Test', 'info', 'Sending 20 rapid notifications...');
            
            for (let i = 1; i <= 20; i++) {
                setTimeout(() => {
                    if (window.app && typeof window.app.showNotification === 'function') {
                        window.app.showNotification(`Stress test notification ${i}`, 
                            i % 4 === 0 ? 'error' : i % 3 === 0 ? 'warning' : 'success', 1000);
                    }
                }, i * 100);
            }
            
            setTimeout(() => {
                addTestResult('Notification Stress Complete', 'success', 'All notifications handled without crashes');
            }, 2500);
        };

        window.stressTestListeners = function() {
            addTestResult('Listener Stress Test', 'info', 'Creating and destroying 50 listeners...');
            
            const listeners = [];
            
            // Create many listeners
            for (let i = 0; i < 50; i++) {
                const listener = () => console.log(`Listener ${i}`);
                window.addEventListener(`test-event-${i}`, listener);
                listeners.push({ event: `test-event-${i}`, listener });
            }
            
            // Clean them up
            setTimeout(() => {
                listeners.forEach(({ event, listener }) => {
                    window.removeEventListener(event, listener);
                });
                addTestResult('Listener Stress Complete', 'success', '50 listeners created and cleaned up successfully');
            }, 1000);
        };

        window.simulateNetworkIssues = function() {
            addTestResult('Network Simulation', 'info', 'Simulating network connectivity issues...');
            
            // Test offline/online events
            window.dispatchEvent(new Event('offline'));
            setTimeout(() => {
                window.dispatchEvent(new Event('online'));
                addTestResult('Network Events', 'success', 'Offline/online events dispatched');
            }, 1000);
        };

        // Run all safety tests
        window.runAllSafetyTests = async function() {
            clearResults();
            addTestResult('Safety Test Suite Started', 'info', 'Running comprehensive safety tests...');

            const tests = [
                testSafeFirebase,
                testSafeTelegram,
                testErrorHandling,
                testConnectionFailures,
                testRetryMechanisms,
                testSafeCleanup,
                testUndefinedHandling
            ];

            for (const test of tests) {
                try {
                    await test();
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Delay between tests
                } catch (error) {
                    addTestResult('Test Suite Error', 'error', `Error running ${test.name}: ${error.message}`);
                }
            }

            addTestResult('Safety Test Suite Complete', 'success', 'All safety tests completed successfully! 🛡️');
        };

        // Check Firebase status
        setTimeout(() => {
            if (window.Firebase) {
                document.getElementById('firebaseStatus').textContent = 'Available ✅';
            } else {
                document.getElementById('firebaseStatus').textContent = 'Not Available ❌';
            }
        }, 2000);

    </script>

    <!-- Load Firebase Configuration -->
    <script type="module" src="js/firebase-config.js"></script>
    <!-- Load Telegram utilities -->
    <script type="module" src="js/telegram.js"></script>
    <!-- Load Database manager -->
    <script type="module" src="js/database.js"></script>
</body>
</html>