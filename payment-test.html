<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⭐ Telegram Star Payment Test Suite</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .test-result {
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }
        .success { background-color: #f0fdf4; border-color: #bbf7d0; }
        .error { background-color: #fef2f2; border-color: #fca5a5; }
        .info { background-color: #eff6ff; border-color: #93c5fd; }
        .warning { background-color: #fffbeb; border-color: #fcd34d; }
        .payment-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .vip-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
    </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8">⭐ Telegram Star Payment Integration Test</h1>
        
        <!-- Payment Environment Info -->
        <div class="bg-white rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Payment Environment</h2>
            <div id="paymentEnvironment" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div><strong>Telegram WebApp:</strong> <span id="telegramStatus" class="font-semibold">Checking...</span></div>
                <div><strong>User ID:</strong> <span id="userId" class="font-mono">Not Available</span></div>
                <div><strong>Start Param:</strong> <span id="startParam" class="font-mono">None</span></div>
                <div><strong>Payment API:</strong> <span id="paymentApiStatus" class="font-semibold">Checking...</span></div>
                <div><strong>VIP Settings:</strong> <span id="vipSettingsStatus" class="font-semibold">Loading...</span></div>
                <div><strong>Firebase Status:</strong> <span id="firebaseStatus" class="font-semibold">Checking...</span></div>
            </div>
        </div>

        <!-- VIP Purchase Demo -->
        <div class="bg-white rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">💎 VIP Purchase Demo</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <!-- Current VIP Status -->
                <div class="space-y-4">
                    <h3 class="font-semibold">Current VIP Status</h3>
                    <div id="currentVipStatus" class="p-4 rounded-lg bg-gray-100">
                        <div class="text-center">
                            <div class="text-2xl mb-2">👤</div>
                            <div class="font-bold">FREE TIER</div>
                            <div class="text-sm text-gray-600">Basic features only</div>
                        </div>
                    </div>
                    
                    <!-- Daily Claim Status -->
                    <div class="p-4 rounded-lg bg-blue-50 border border-blue-200">
                        <h4 class="font-semibold mb-2">🎁 Daily Claim</h4>
                        <div id="dailyClaimStatus">
                            <button id="testDailyClaim" class="bg-blue-500 text-white px-4 py-2 rounded text-sm">
                                Claim 100 Coins
                            </button>
                        </div>
                    </div>
                </div>

                <!-- VIP Upgrade Card -->
                <div class="vip-card text-white p-6 rounded-lg">
                    <div class="text-center">
                        <div class="text-3xl mb-2">👑</div>
                        <h3 class="text-xl font-bold mb-2">VIP MEMBERSHIP</h3>
                        <div class="text-sm opacity-90 mb-4">Unlock premium benefits</div>
                        
                        <!-- VIP Benefits -->
                        <div class="text-left space-y-2 mb-6 text-sm">
                            <div>✨ 2x Farming Rewards</div>
                            <div>🚀 1.5x Referral Bonus</div>
                            <div>🎁 +200 Daily Claim Bonus</div>
                            <div>💰 Lower Withdrawal Limits</div>
                        </div>
                        
                        <!-- Price Display -->
                        <div class="mb-4">
                            <div class="text-2xl font-bold" id="vipPriceDisplay">Loading...</div>
                            <div class="text-xs opacity-75" id="vipDurationDisplay">Duration: Loading...</div>
                        </div>
                        
                        <!-- Purchase Button -->
                        <button id="buyVipButton" class="bg-white text-purple-600 px-6 py-3 rounded-full font-bold w-full">
                            ⭐ Buy VIP Now
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Test Controls -->
        <div class="bg-white rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">🧪 Payment Tests</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <button onclick="testVipSettings()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    ⚙️ Test VIP Settings
                </button>
                <button onclick="testPaymentData()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    💳 Test Payment Data
                </button>
                <button onclick="testVipActivation()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                    👑 Test VIP Activation
                </button>
                <button onclick="testDailyClaimSystem()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                    🎁 Test Daily Claims
                </button>
                <button onclick="simulateSuccessfulPayment()" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600">
                    ✅ Simulate Success
                </button>
                <button onclick="simulateFailedPayment()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                    ❌ Simulate Failure
                </button>
                <button onclick="testPaymentSafety()" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                    🛡️ Safety Tests
                </button>
                <button onclick="runAllPaymentTests()" class="bg-gray-800 text-white px-4 py-2 rounded hover:bg-gray-900">
                    🚀 Run All Tests
                </button>
            </div>
        </div>

        <!-- Admin VIP Settings Panel -->
        <div class="bg-white rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">🛠️ Admin VIP Configuration</h2>
            <form id="testVipSettingsForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">VIP Price</label>
                    <input type="number" id="testVipAmount" value="99" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Currency</label>
                    <select id="testVipCurrency" class="w-full p-2 border rounded">
                        <option value="XTR">Telegram Stars</option>
                        <option value="INR">Indian Rupees</option>
                        <option value="USD">US Dollars</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Duration (Days)</label>
                    <input type="number" id="testVipDuration" value="30" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Daily Bonus</label>
                    <input type="number" id="testDailyBonus" value="200" class="w-full p-2 border rounded">
                </div>
                <div class="md:col-span-2">
                    <button type="button" onclick="updateTestVipSettings()" class="bg-purple-500 text-white px-6 py-2 rounded">
                        💎 Update Test Settings
                    </button>
                </div>
            </form>
        </div>

        <!-- Test Results -->
        <div class="bg-white rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Test Results</h2>
            <div class="mb-4">
                <button onclick="clearResults()" class="bg-gray-500 text-white px-3 py-1 rounded text-sm">
                    Clear Results
                </button>
            </div>
            <div id="testResults" class="space-y-2">
                <div class="test-result info">
                    <strong>Payment Test Suite Ready</strong> - Telegram Star Payment integration loaded and ready for testing
                </div>
            </div>
        </div>
    </div>

    <!-- Load Scripts -->
    <script type="module">
        // Test results container
        const testResults = document.getElementById('testResults');

        function addTestResult(title, status, details = '') {
            const result = document.createElement('div');
            result.className = `test-result ${status}`;
            result.innerHTML = `
                <strong>${title}</strong> - ${
                    status === 'success' ? 'PASS ✅' : 
                    status === 'error' ? 'FAIL ❌' : 
                    status === 'warning' ? 'WARN ⚠️' :
                    'INFO ℹ️'
                }
                ${details ? `<div class="text-sm mt-2 font-mono">${details}</div>` : ''}
                <div class="text-xs text-gray-500 mt-1">${new Date().toLocaleTimeString()}</div>
            `;
            testResults.appendChild(result);
            result.scrollIntoView({ behavior: 'smooth' });
        }

        window.clearResults = function() {
            testResults.innerHTML = '';
        };

        // Initialize environment info
        function updateEnvironmentInfo() {
            // Telegram Status
            const telegramStatus = document.getElementById('telegramStatus');
            const userId = document.getElementById('userId');
            const startParam = document.getElementById('startParam');
            const paymentApiStatus = document.getElementById('paymentApiStatus');

            if (window.Telegram?.WebApp) {
                telegramStatus.textContent = 'Available ✅';
                telegramStatus.className = 'font-semibold text-green-600';
                
                const user = window.Telegram.WebApp.initDataUnsafe?.user;
                if (user) {
                    userId.textContent = user.id;
                }
                
                const startParamValue = window.Telegram.WebApp.initDataUnsafe?.start_param;
                if (startParamValue) {
                    startParam.textContent = startParamValue;
                }

                // Check payment API availability
                if (typeof window.Telegram.WebApp.sendData === 'function') {
                    paymentApiStatus.textContent = 'sendData Available ✅';
                    paymentApiStatus.className = 'font-semibold text-green-600';
                } else if (typeof window.Telegram.WebApp.openInvoice === 'function') {
                    paymentApiStatus.textContent = 'openInvoice Available ⚠️';
                    paymentApiStatus.className = 'font-semibold text-yellow-600';
                } else {
                    paymentApiStatus.textContent = 'Not Available ❌';
                    paymentApiStatus.className = 'font-semibold text-red-600';
                }
            } else {
                telegramStatus.textContent = 'Not Available (Test Mode) ⚠️';
                telegramStatus.className = 'font-semibold text-yellow-600';
                paymentApiStatus.textContent = 'Test Mode ⚠️';
                paymentApiStatus.className = 'font-semibold text-yellow-600';
            }
        }

        // ✅ Test VIP Settings
        window.testVipSettings = async function() {
            addTestResult('VIP Settings Test', 'info', 'Testing VIP configuration loading...');

            try {
                // Wait for Firebase
                while (!window.Firebase) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                const vipSettings = await window.Firebase.getVIPSettings();
                
                addTestResult('VIP Settings Load', 'success', 
                    `Loaded VIP settings: ${vipSettings.vipAmount} ${vipSettings.vipCurrency} for ${vipSettings.vipDuration} days`);

                // Update UI
                updateVipDisplay(vipSettings);

                // Test all required fields
                const requiredFields = ['vipAmount', 'vipCurrency', 'vipDuration', 'vipBenefits'];
                const missingFields = requiredFields.filter(field => !vipSettings[field]);
                
                if (missingFields.length === 0) {
                    addTestResult('VIP Settings Validation', 'success', 'All required VIP settings fields present');
                } else {
                    addTestResult('VIP Settings Validation', 'warning', `Missing fields: ${missingFields.join(', ')}`);
                }

            } catch (error) {
                addTestResult('VIP Settings Error', 'error', error.message);
            }
        };

        // ✅ Test Payment Data Generation
        window.testPaymentData = async function() {
            addTestResult('Payment Data Test', 'info', 'Testing payment data generation...');

            try {
                const mockPayload = {
                    userId: 'test_user_123',
                    plan: 'VIP',
                    timestamp: Date.now()
                };

                // Test payment data structure
                const paymentData = {
                    type: "invoice",
                    title: "VIP Membership",
                    description: "Test VIP purchase",
                    payload: JSON.stringify(mockPayload),
                    provider_token: "TEST_TOKEN",
                    currency: "XTR",
                    prices: [{ label: "VIP Membership", amount: 99 }]
                };

                // Validate payment data structure
                const requiredFields = ['type', 'title', 'description', 'payload', 'currency', 'prices'];
                const hasAllFields = requiredFields.every(field => paymentData[field]);

                if (hasAllFields) {
                    addTestResult('Payment Data Structure', 'success', 
                        `Valid payment data: ${JSON.stringify(paymentData, null, 2)}`);
                } else {
                    addTestResult('Payment Data Structure', 'error', 'Invalid payment data structure');
                }

                // Test payload parsing
                const parsedPayload = JSON.parse(paymentData.payload);
                if (parsedPayload.userId && parsedPayload.plan) {
                    addTestResult('Payment Payload', 'success', 'Payload correctly formatted and parseable');
                } else {
                    addTestResult('Payment Payload', 'error', 'Payload missing required fields');
                }

            } catch (error) {
                addTestResult('Payment Data Error', 'error', error.message);
            }
        };

        // ✅ Test VIP Activation
        window.testVipActivation = async function() {
            addTestResult('VIP Activation Test', 'info', 'Testing VIP activation process...');

            try {
                const testUserId = 'test_user_' + Date.now();
                
                // Test VIP activation
                const activated = await window.Firebase?.activateVIP(testUserId, 30);
                
                if (activated) {
                    addTestResult('VIP Activation', 'success', `VIP activated for user ${testUserId}`);
                    
                    // Test VIP status check
                    const isVIP = await window.Firebase?.checkVIPStatus(testUserId);
                    addTestResult('VIP Status Check', isVIP ? 'success' : 'error', 
                        `VIP status check: ${isVIP ? 'Active' : 'Inactive'}`);
                } else {
                    addTestResult('VIP Activation', 'error', 'Failed to activate VIP');
                }

            } catch (error) {
                addTestResult('VIP Activation Error', 'error', error.message);
            }
        };

        // ✅ Test Daily Claim System
        window.testDailyClaimSystem = async function() {
            addTestResult('Daily Claim Test', 'info', 'Testing daily claim functionality...');

            try {
                const testUserId = 'test_daily_' + Date.now();
                
                // Create test user
                await window.Firebase?.createUser(testUserId, { coins: 0 });
                
                // Test daily claim
                const claimResult = await window.Firebase?.processDailyClaim(testUserId);
                
                if (claimResult.success) {
                    addTestResult('Daily Claim Success', 'success', 
                        `Claimed ${claimResult.reward} coins: ${claimResult.message}`);
                    
                    // Test second claim (should fail)
                    const secondClaim = await window.Firebase?.processDailyClaim(testUserId);
                    if (!secondClaim.success) {
                        addTestResult('Daily Claim Cooldown', 'success', 'Cooldown working: ' + secondClaim.message);
                    } else {
                        addTestResult('Daily Claim Cooldown', 'error', 'Cooldown not working - second claim succeeded');
                    }
                } else {
                    addTestResult('Daily Claim Failed', 'error', claimResult.message);
                }

            } catch (error) {
                addTestResult('Daily Claim Error', 'error', error.message);
            }
        };

        // ✅ Simulate Successful Payment
        window.simulateSuccessfulPayment = async function() {
            addTestResult('Payment Success Simulation', 'info', 'Simulating successful payment flow...');

            try {
                const testUserId = 'sim_user_' + Date.now();
                
                // Simulate payment success
                if (window.TelegramApp) {
                    const mockPayload = {
                        userId: testUserId,
                        plan: 'VIP',
                        duration: 30
                    };
                    
                    await window.TelegramApp.onPaymentSuccess(mockPayload);
                    addTestResult('Payment Success Flow', 'success', 'Payment success handler executed');
                    
                    // Check if VIP was activated
                    setTimeout(async () => {
                        const isVIP = await window.Firebase?.checkVIPStatus(testUserId);
                        addTestResult('Post-Payment VIP Check', isVIP ? 'success' : 'warning', 
                            `VIP status after payment: ${isVIP ? 'Active' : 'Inactive'}`);
                    }, 1000);
                }

            } catch (error) {
                addTestResult('Payment Simulation Error', 'error', error.message);
            }
        };

        // ✅ Simulate Failed Payment
        window.simulateFailedPayment = function() {
            addTestResult('Payment Failure Simulation', 'info', 'Simulating failed payment scenarios...');

            try {
                // Test various failure modes
                const failures = [
                    { status: 'cancelled', expected: 'Payment cancelled' },
                    { status: 'failed', expected: 'Payment failed' },
                    { status: 'timeout', expected: 'Unknown status' }
                ];

                failures.forEach((failure, index) => {
                    setTimeout(() => {
                        if (window.TelegramApp) {
                            window.TelegramApp.handlePaymentStatus(failure.status, {});
                            addTestResult(`Payment Failure ${index + 1}`, 'success', 
                                `Handled ${failure.status} status correctly`);
                        }
                    }, index * 500);
                });

            } catch (error) {
                addTestResult('Payment Failure Error', 'error', error.message);
            }
        };

        // ✅ Test Payment Safety
        window.testPaymentSafety = function() {
            addTestResult('Payment Safety Test', 'info', 'Testing payment safety mechanisms...');

            try {
                // Test invalid payment data
                const invalidTests = [
                    { amount: null, title: null, description: null },
                    { amount: -100, title: '', description: undefined },
                    { amount: 'invalid', title: {}, description: [] }
                ];

                invalidTests.forEach((testData, index) => {
                    try {
                        if (window.TelegramApp) {
                            const result = window.TelegramApp.requestStarPayment(
                                testData.amount, testData.title, testData.description, {}
                            );
                            addTestResult(`Safety Test ${index + 1}`, 'success', 'Invalid data handled gracefully');
                        }
                    } catch (error) {
                        addTestResult(`Safety Test ${index + 1}`, 'success', 'Exception caught: ' + error.message);
                    }
                });

            } catch (error) {
                addTestResult('Payment Safety Error', 'error', error.message);
            }
        };

        // ✅ Update VIP Settings
        window.updateTestVipSettings = async function() {
            const vipSettings = {
                vipAmount: parseInt(document.getElementById('testVipAmount').value),
                vipCurrency: document.getElementById('testVipCurrency').value,
                vipDuration: parseInt(document.getElementById('testVipDuration').value),
                vipBenefits: {
                    dailyClaimBonus: parseInt(document.getElementById('testDailyBonus').value)
                }
            };

            try {
                await window.Firebase?.updateVIPSettings(vipSettings);
                addTestResult('VIP Settings Update', 'success', 'Test VIP settings updated successfully');
                updateVipDisplay(vipSettings);
            } catch (error) {
                addTestResult('VIP Settings Update Error', 'error', error.message);
            }
        };

        // Update VIP display
        function updateVipDisplay(vipSettings) {
            const priceDisplay = document.getElementById('vipPriceDisplay');
            const durationDisplay = document.getElementById('vipDurationDisplay');
            
            if (priceDisplay) {
                const price = vipSettings.vipCurrency === 'XTR' ? 
                    `${vipSettings.vipAmount} Stars` : 
                    `${(vipSettings.vipAmount / 100).toFixed(2)} ${vipSettings.vipCurrency}`;
                priceDisplay.textContent = price;
            }
            
            if (durationDisplay) {
                durationDisplay.textContent = `Duration: ${vipSettings.vipDuration} days`;
            }
        }

        // ✅ VIP Purchase Button
        document.getElementById('buyVipButton').addEventListener('click', async () => {
            if (window.TelegramApp) {
                addTestResult('VIP Purchase Initiated', 'info', 'Starting VIP purchase flow...');
                await window.TelegramApp.buyVIP();
            } else {
                addTestResult('VIP Purchase Error', 'error', 'TelegramApp not available');
            }
        });

        // ✅ Daily Claim Button
        document.getElementById('testDailyClaim').addEventListener('click', async () => {
            const testUserId = 'daily_test_' + Date.now();
            const result = await window.Firebase?.processDailyClaim(testUserId);
            
            if (result.success) {
                addTestResult('Daily Claim Test', 'success', `Claimed ${result.reward} coins`);
            } else {
                addTestResult('Daily Claim Test', 'info', result.message);
            }
        });

        // ✅ Run All Tests
        window.runAllPaymentTests = async function() {
            clearResults();
            addTestResult('Payment Test Suite Started', 'info', 'Running comprehensive payment tests...');

            const tests = [
                testVipSettings,
                testPaymentData,
                testVipActivation,
                testDailyClaimSystem,
                simulateSuccessfulPayment,
                testPaymentSafety
            ];

            for (const test of tests) {
                try {
                    await test();
                    await new Promise(resolve => setTimeout(resolve, 1000));
                } catch (error) {
                    addTestResult('Test Suite Error', 'error', `Error in ${test.name}: ${error.message}`);
                }
            }

            addTestResult('Payment Test Suite Complete', 'success', 'All payment tests completed! 🎉');
        };

        // Initialize on load
        setTimeout(() => {
            updateEnvironmentInfo();
            
            // Check Firebase status
            if (window.Firebase) {
                document.getElementById('firebaseStatus').textContent = 'Available ✅';
                document.getElementById('firebaseStatus').className = 'font-semibold text-green-600';
                
                // Load and display VIP settings
                testVipSettings();
            } else {
                document.getElementById('firebaseStatus').textContent = 'Not Available ❌';
                document.getElementById('firebaseStatus').className = 'font-semibold text-red-600';
            }
            
            document.getElementById('vipSettingsStatus').textContent = 'Loaded ✅';
            document.getElementById('vipSettingsStatus').className = 'font-semibold text-green-600';
        }, 2000);
    </script>

    <!-- Load Firebase and App Scripts -->
    <script type="module" src="js/firebase-config.js"></script>
    <script type="module" src="js/telegram.js"></script>
</body>
</html>